---
alwaysApply: true
---
# Rule-Finder Project Guidelines

> Full documentation: **[AGENTS.md](../../AGENTS.md)**

## Stack
- Next.js 16 App Router, TypeScript strict mode
- Tailwind CSS v4 (mobile-first), Shadcn/ui components
- Supabase (Postgres + Storage), OpenAI Responses API, Gemini
- Deployed on Vercel

## Code Patterns

**React:** Server Components default; Client Components only when needed. Handle loading/error/empty states.

**API Routes:** Validate input, return `{ data }` or `{ error: string }`. Use `ApiResponse<T>` type.

**TypeScript:** Explicit return types. Prefer discriminated unions over optional fields.

**Files:** Components in `components/`, helpers in `lib/<domain>.ts`, types in `types/`.

## Key Constraints

- **Vercel 4.5MB limit** — never POST raw PDFs through API routes
- **1 PDF page = 1 OpenAI file** — enables page-level citation mapping
- **pdf.js client-side only** — use `next/dynamic` with `ssr: false`

## Critical Patterns (Do Not Break)

### Citation Extraction
Extract from `message.content.annotations` only. Do NOT use `file_search_call.results` (returns all searched files, not cited ones).

```typescript
for (const item of response.output) {
  if (item.type === "message") {
    for (const content of item.content) {
      if (content.type === "output_text" && content.annotations) {
        for (const annotation of content.annotations) {
          if (annotation.type === "file_citation" && annotation.file_id) {
            // Map file_id → page_number via rulebook_pages table
          }
        }
      }
    }
  }
}
```

### pdf.js SSR Fix
```typescript
const RulebookViewer = dynamic(() => import("@/components/RulebookViewer"), {
  ssr: false,
});
```

### Canvas Race Condition
Track both `renderedPages` AND `renderingPages` refs to prevent concurrent renders.

### OpenAI Model
Use `gpt-5.1` for ask endpoint. Do not change.
